<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Search</title>
    <style>
        :root{--bg:#0b0c0f;--elev:#12141a;--muted:#9aa3b2;--text:#e7ecf3;--accent:#3b82f6;--radius:12px;--border:#1f2430;--row:#0e1117}
        *{box-sizing:border-box} html,body{height:100%} body{margin:0;font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica Neue,Arial,Noto Sans;color:var(--text);background:var(--bg)} a{color:#9ec3ff;text-decoration:none} a:hover{text-decoration:underline}
        .wrap{max-width:1240px;margin:0 auto;padding:26px 16px 44px} header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
        .brand{display:flex;align-items:center;gap:10px}.logo{width:36px;height:36px;border-radius:9px;background:linear-gradient(135deg,var(--accent),#60a5fa);box-shadow:0 10px 24px rgba(59,130,246,.3)} h1{font-size:20px;margin:0}
        nav a{padding:8px 12px;border-radius:10px} nav a:hover{background:#171b25}
        .card{background:var(--elev);border:1px solid var(--border);border-radius:var(--radius);padding:14px;box-shadow:0 8px 18px rgba(0,0,0,.35)}
        .grid{display:grid;grid-template-columns:1fr;gap:12px}
        .controls{display:grid;grid-template-columns:repeat(12,1fr);gap:10px;align-items:end}
        .f{display:flex;flex-direction:column;gap:6px} label{color:var(--muted);font-size:12px}
        input[type=text],input[type=number],select{width:100%;background:#0f1218;border:1px solid var(--border);color:var(--text);padding:10px 12px;border-radius:10px}
        .btn{display:inline-flex;align-items:center;gap:8px;background:var(--accent);color:#fff;padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:600}
        .btn.ghost{background:transparent;color:var(--text);border:1px solid var(--border)} .btn:disabled{opacity:.6;cursor:not-allowed}
        .info-row{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-top:8px} .muted{color:var(--muted)}
        table{width:100%;border-collapse:separate;border-spacing:0;margin-top:12px}
        thead th{position:sticky;top:0;background:#0f1218;color:var(--muted);font-weight:600;text-align:left;padding:10px;border-bottom:1px solid var(--border);z-index:1}
        tbody td{padding:10px;border-bottom:1px solid #131824;background:var(--row)} tbody tr:hover td{background:#131722}
        .right{text-align:right}
        .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#0f1625;border:1px solid var(--border);font-size:12px}
        details.columns{margin-top:8px}
        .cols-grid{display:grid;grid-template-columns:repeat(4,minmax(160px,1fr));gap:8px;margin-top:8px}
        .cols-actions{display:flex;gap:8px;margin-top:8px}
        @media (max-width:980px){.controls{grid-template-columns:repeat(6,1fr)}.cols-grid{grid-template-columns:repeat(2,minmax(160px,1fr))}}
        @media (max-width:640px){.controls{grid-template-columns:repeat(3,1fr)}}
    </style>
</head>
<body>
<div class="wrap">
    <header>
        <div class="brand"><div class="logo" aria-hidden="true"></div><h1>GPU Finder — Search</h1></div>
        <nav><a href="index.html">Home</a><a href="about.html">About</a></nav>
    </header>

    <section class="grid">
        <div class="card">
            <form id="form" class="controls" autocomplete="off">
                <div class="f" style="grid-column: span 3; min-width: 160px;">
                    <label for="source">Provider <span class="muted">(exact)</span></label>
                    <input id="source" name="source" type="text" list="dl-sources" placeholder="e.g., vastai" />
                    <datalist id="dl-sources"></datalist>
                </div>
                <div class="f" style="grid-column: span 3; min-width: 160px;">
                    <label for="location">Location <span class="muted">(substring)</span></label>
                    <input id="location" name="location" type="text" list="dl-locations" placeholder="e.g., us-west" />
                    <datalist id="dl-locations"></datalist>
                </div>
                <div class="f" style="grid-column: span 2; min-width: 120px;">
                    <label for="max_price">Max price ($/h)</label>
                    <input id="max_price" name="max_price" type="number" min="0" step="0.01" />
                </div>
                <div class="f" style="grid-column: span 2; min-width: 120px;">
                    <label for="min_flopsd">Min FLOPs per $/h</label>
                    <input id="min_flopsd" name="min_flopsd" type="number" min="0" step="0.01" />
                </div>
                <div class="f" style="grid-column: span 2; min-width: 160px;">
                    <label for="sort_col">Sort column</label>
                    <select id="sort_col" name="sort_col"></select>
                </div>
                <div class="f" style="grid-column: span 1; min-width: 100px;">
                    <label for="sort_dir">Dir</label>
                    <select id="sort_dir" name="sort_dir"><option value="desc">desc</option><option value="asc">asc</option></select>
                </div>
                <div class="f" style="grid-column: span 2; min-width: 120px;">
                    <label for="limit">Limit</label>
                    <select id="limit" name="limit"><option>50</option><option selected>200</option><option>500</option><option>1000</option></select>
                </div>
                <div class="f" style="grid-column: span 12; display:flex; gap:10px; margin-top: 6px;">
                    <button class="btn" type="submit" id="btn-search">Search</button>
                    <button class="btn ghost" type="button" id="btn-reset">Reset</button>
                </div>
            </form>

            <details class="columns" id="colPicker">
                <summary>Columns</summary>
                <div class="cols-actions">
                    <button class="btn ghost" type="button" id="btn-basic">Basic</button>
                    <button class="btn ghost" type="button" id="btn-all">Select all</button>
                </div>
                <div class="cols-grid" id="cols-grid"></div>
                <p class="muted" style="margin-top:6px;font-size:12px;">Memory shown as <strong>GB</strong> (MB/1024). Network shown as <strong>Gbps</strong> (Mbps/1000). Clicking a <strong>Name</strong> opens its URL.</p>
            </details>

            <div class="info-row">
                <div class="muted" id="status">Ready.</div>
                <div class="pagination">
                    <button class="btn ghost" id="prevBtn" disabled>← Prev</button>
                    <span class="muted" id="pageInfo">offset 0</span>
                    <button class="btn ghost" id="nextBtn" disabled>Next →</button>
                </div>
            </div>

            <div style="margin-top:10px; overflow:auto; border:1px solid var(--border); border-radius: 10px;">
                <table id="tbl"><thead><tr id="thead-row"></tr></thead><tbody id="rows"></tbody></table>
            </div>
        </div>
    </section>
</div>

<script>
    const API='https://gpu-api-891435322100.us-central1.run.app/gpus';
    const form=qs('#form'); const statusEl=qs('#status'); const rowsEl=qs('#rows'); const theadRow=qs('#thead-row');
    const prevBtn=qs('#prevBtn'); const nextBtn=qs('#nextBtn'); const pageInfo=qs('#pageInfo');
    const dlSources=qs('#dl-sources'); const dlLocations=qs('#dl-locations');
    const sortColSel=qs('#sort_col'); const sortDirSel=qs('#sort_dir');

    // Column definitions (include all model fields + derived)
    const COLS=[
        {key:'source', label:'Provider'},
        {key:'location', label:'Location'},
        {key:'name', label:'Name'},
        {key:'num_gpus', label:'#GPUs', align:'right'},
        {key:'vram_gb', label:'VRAM (GB)', align:'right', sortKey:'vram_mb'},
        {key:'ram_gb', label:'RAM (GB)', align:'right', sortKey:'ram_mb'},
        {key:'total_flops', label:'Total FLOPs', align:'right'},
        {key:'flops_per_dollar_ph', label:'FLOPs/$·h', align:'right'},
        {key:'total_cost_ph', label:'$ / h', align:'right'},
        {key:'reliability', label:'Reliability %', align:'right'},
        {key:'gpu_mem_bw_gbps', label:'GPU Mem BW (GB/s)', align:'right'},
        {key:'cpu_cores', label:'CPU Cores', align:'right'},
        {key:'cpu_name', label:'CPU Name'},
        {key:'cpu_ghz', label:'CPU GHz', align:'right'},
        {key:'cpu_arch', label:'CPU Arch'},
        {key:'disk_space_gb', label:'Disk (GB)', align:'right'},
        {key:'disk_bw_gbps', label:'Disk BW (GB/s)', align:'right'},
        {key:'disk_name', label:'Disk Name'},
        {key:'upload_gbps', label:'Up (Gbps)', align:'right', sortKey:'upload_mbps'},
        {key:'download_gbps', label:'Down (Gbps)', align:'right', sortKey:'download_mbps'},
        {key:'gpu_cost_ph', label:'GPU $/h', align:'right'},
        {key:'disk_cost_ph', label:'Disk $/h', align:'right'},
        {key:'upload_cost_ph', label:'Upload $/h', align:'right'},
        {key:'download_cost_ph', label:'Download $/h', align:'right'},
        {key:'id', label:'ID'},
        {key:'updated_at', label:'Updated'},
        {key:'url', label:'URL'}, // Optional plain URL text
    ];

    const BASIC=['source','location','name','num_gpus','vram_gb','ram_gb','total_flops','flops_per_dollar_ph','total_cost_ph','reliability','upload_gbps','download_gbps'];

    // Build column picker
    const colsGrid=qs('#cols-grid');
    const selectedCols=new Set();
    const qsCols=getQS('cols');
    const initial=BASIC.slice();
    if(qsCols){
        const split=qsCols.split(',').map(s=>s.trim()).filter(s=>COLS.some(c=>c.key===s));
        if(split.length) split.forEach(k=>selectedCols.add(k)); else initial.forEach(k=>selectedCols.add(k));
    } else initial.forEach(k=>selectedCols.add(k));

    // Render checkboxes
    colsGrid.innerHTML=COLS.map(c=>{
        const checked=selectedCols.has(c.key)?'checked':'';
        return `<label><input type="checkbox" data-col="${c.key}" ${checked}/> ${escapeHtml(c.label)} <span class="muted" style="font-size:11px">(${c.key})</span></label>`;
    }).join('');

    colsGrid.addEventListener('change',e=>{
        const input=e.target; if(input && input.dataset.col){
        if(input.checked) selectedCols.add(input.dataset.col); else selectedCols.delete(input.dataset.col);
        offset=0; persistCols(); renderHeaders(); doSearch();
    }
    });
    qs('#btn-all').addEventListener('click',()=>{ COLS.forEach(c=>selectedCols.add(c.key)); syncCheckboxes(); offset=0; persistCols(); renderHeaders(); doSearch(); });
    qs('#btn-basic').addEventListener('click',()=>{ selectedCols.clear(); BASIC.forEach(k=>selectedCols.add(k)); syncCheckboxes(); offset=0; persistCols(); renderHeaders(); doSearch(); });

    function syncCheckboxes(){
        colsGrid.querySelectorAll('input[type=checkbox]').forEach(cb=>{ cb.checked=selectedCols.has(cb.dataset.col); });
    }
    function persistCols(){ const u=new URL(location.href); u.searchParams.set('cols',[...selectedCols].join(',')); history.replaceState(null,'',u.toString()); }

    // Populate sort options from API-visible keys (use underlying sortKey when derived)
    sortColSel.innerHTML = COLS.map(c=>{
        const apiKey = c.sortKey || c.key; return `<option value="${apiKey}">${apiKey}</option>`;
    }).join('');

    // Default sort
    const qsSort=getQS('sort');
    sortColSel.value = (qsSort?qsSort.split('.')[0]:'total_cost_ph');
    sortDirSel.value = (qsSort?qsSort.split('.')[1]:'desc');

    // Initialize form from URL
    ['source','location','max_price','min_flopsd','limit'].forEach(f=>{ const v=getQS(f); if(v!=null) qs('#'+f).value=v; });
    let offset = parseInt(getQS('offset')||'0',10)||0;

    // Prime datalists
    primeDatalists().catch(()=>{});

    // Events
    form.addEventListener('submit',e=>{e.preventDefault();offset=0;doSearch();});
    qs('#btn-reset').addEventListener('click',()=>{ resetForm(); offset=0; doSearch(); });
    prevBtn.addEventListener('click',()=>{ if(offset>0){ offset=Math.max(0, offset-getLimit()); doSearch(); }});
    nextBtn.addEventListener('click',()=>{ offset+=getLimit(); doSearch(); });

    // Initial render
    renderHeaders();

    // Ensure initial search happens after DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            offset = 0;
            doSearch();
        });
    } else {
        offset = 0;
        doSearch();
    }

    let inflight;

    async function primeDatalists(){
        const url=new URL(API); url.searchParams.set('limit','200'); const r=await fetch(url); const rows=await r.json();
        const sources=[...new Set(rows.map(x=>x.source).filter(Boolean))].sort();
        const locs=[...new Set(rows.map(x=>x.location).filter(Boolean))].sort();
        dlSources.innerHTML=sources.map(s=>`<option value="${escapeHtml(s)}"></option>`).join('');
        dlLocations.innerHTML=locs.map(s=>`<option value="${escapeHtml(s)}"></option>`).join('');
    }

    function getLimit(){ return parseInt(qs('#limit').value,10); }

    function currentSort(){ return `${sortColSel.value}.${sortDirSel.value}`; }

    async function doSearch(){
        const params=new URLSearchParams();
        const source=qs('#source').value.trim();
        const location=qs('#location').value.trim();
        const max_price=qs('#max_price').value.trim();
        const min_flopsd=qs('#min_flopsd').value.trim();
        const sort=currentSort();
        const limit=getLimit();
        if(source) params.set('source',source);
        if(location) params.set('location',location);
        if(max_price) params.set('max_price',max_price);
        if(min_flopsd) params.set('min_flopsd',min_flopsd);
        if(sort) params.set('sort',sort);
        params.set('limit', String(limit));
        params.set('offset', String(offset));
        // Keep cols in URL
        const colsParam=[...selectedCols].join(','); if(colsParam) params.set('cols', colsParam);

        // Update URL
        const share=new URLSearchParams(params); history.replaceState(null,'', `${locationPath()}?${share.toString()}`);

        if(inflight) inflight.abort(); inflight=new AbortController();
        const url=`${API}?${params.toString()}`;
        statusEl.textContent='Loading…'; rowsEl.innerHTML=''; pageInfo.textContent=`offset ${offset.toLocaleString()}`;
        try{
            const res=await fetch(url,{signal:inflight.signal}); if(!res.ok) throw new Error(`${res.status} ${res.statusText}`);
            const rows=await res.json();
            renderRows(rows);
            statusEl.textContent=`${rows.length.toLocaleString()} result(s)`;
            prevBtn.disabled = offset<=0; nextBtn.disabled = rows.length < limit;
        }catch(err){ if(err.name==='AbortError') return; statusEl.textContent=`Error: ${err.message}`; rowsEl.innerHTML=''; prevBtn.disabled=true; nextBtn.disabled=true; }
    }

    function renderHeaders(){
        const cols=[...selectedCols];
        theadRow.innerHTML = cols.map(k=>{ const c=COLS.find(x=>x.key===k); const align=c?.align==='right'?' class="right"':''; return `<th data-key="${c.key}"${align}>${escapeHtml(c.label)}</th>`; }).join('');
        // header click sorting
        theadRow.querySelectorAll('th').forEach(th=>{
            th.style.cursor='pointer'; th.title='Sort by '+th.dataset.key;
            th.onclick=()=>{
            const key=th.dataset.key; const col=COLS.find(c=>c.key===key); const apiKey=(col.sortKey||col.key);
        if(sortColSel.value===apiKey){ sortDirSel.value = (sortDirSel.value==='desc'?'asc':'desc'); }
        else { sortColSel.value=apiKey; sortDirSel.value='desc'; }
        offset=0; doSearch();
    };
    });
        // Also refresh sort dropdown to include all api keys once
        // (already populated at init)
    }

    function renderRows(rows){
        const cols=[...selectedCols];
        rowsEl.innerHTML = rows.map(r=>{
            return `<tr>${cols.map(k=>`<td${COLS.find(c=>c.key===k)?.align==='right'?' class=\"right\"':''}>${renderCell(k,r)}</td>`).join('')}</tr>`;
        }).join('') || `<tr><td colspan="${cols.length}" class="muted">No results.</td></tr>`;
    }

    function renderCell(key,r){
        switch(key){
            case 'source': return `<span class="pill">${escapeHtml(r.source||'—')}</span>`;
            case 'name': return r.url ? `<a href="${escapeAttr(r.url)}" target="_blank" rel="noopener">${escapeHtml(r.name||'—')}</a>` : escapeHtml(r.name||'—');
            case 'vram_gb': return fmtGB(r.vram_mb);
            case 'ram_gb': return fmtGB(r.ram_mb);
            case 'reliability': return isFiniteNum(r.reliability)? (r.reliability*100).toFixed(0)+'%':'—';
            case 'upload_gbps': return fmtGbps(r.upload_mbps);
            case 'download_gbps': return fmtGbps(r.download_mbps);
            case 'total_cost_ph': return fmtMoney(r.total_cost_ph);
            case 'gpu_cost_ph': return fmtMoney(r.gpu_cost_ph);
            case 'disk_cost_ph': return fmtMoney(r.disk_cost_ph);
            case 'upload_cost_ph': return fmtMoney(r.upload_cost_ph);
            case 'download_cost_ph': return fmtMoney(r.download_cost_ph);
            case 'cpu_ghz': return fmtNum(r.cpu_ghz);
            case 'cpu_cores': return fmtInt(r.cpu_cores);
            case 'num_gpus': return fmtInt(r.num_gpus);
            case 'disk_space_gb': return fmtInt(r.disk_space_gb);
            case 'disk_bw_gbps': return fmtNum(r.disk_bw_gbps);
            case 'gpu_mem_bw_gbps': return fmtNum(r.gpu_mem_bw_gbps);
            case 'flops_per_dollar_ph': return fmtNum(r.flops_per_dollar_ph);
            case 'total_flops': return fmtNum(r.total_flops);
            case 'updated_at': return escapeHtml(r.updated_at||'—');
            case 'url': return r.url ? `<a href="${escapeAttr(r.url)}" target="_blank" rel="noopener">${escapeHtml(r.url)}</a>` : '—';
            default: return escapeHtml(String(r[key]??'—'));
        }
    }

    // Helpers
    function fmtNum(x){ const n=Number(x); return Number.isFinite(n)? n.toLocaleString(undefined,{maximumFractionDigits:3}) : '—'; }
    function fmtInt(x){ const n=Number(x); return Number.isFinite(n)? n.toLocaleString() : '—'; }
    function fmtMoney(x){ const n=Number(x); return Number.isFinite(n)? ('$'+n.toFixed(2)) : '—'; }
    function fmtGB(mb){ const n=Number(mb); return Number.isFinite(n)? (n/1024).toFixed(1)+' GB':'—'; }
    function fmtGbps(mbps){ const n=Number(mbps); return Number.isFinite(n)? (n/1000).toFixed(2)+' Gbps':'—'; }
    function isFiniteNum(x){ const n=Number(x); return Number.isFinite(n); }
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }
    function escapeAttr(s){ return String(s).replace(/"/g,'&quot;'); }
    function locationPath(){ return location.pathname.split('/').pop(); }
    function qs(sel){ return document.querySelector(sel); }
    function getQS(key){ const u=new URL(location.href); return u.searchParams.get(key); }

    async function resetForm(){ ['source','location','max_price','min_flopsd'].forEach(id=>qs('#'+id).value=''); sortColSel.value='total_cost_ph'; sortDirSel.value='desc'; }

</script>
</body>
</html>